name: Deploy to Railway

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      # REQUIRED: add RAILWAY_TOKEN as a repository secret (use a project token)
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
      # OPTIONAL: set RAILWAY_PROJECT_ID in secrets if you want to pass --project-id explicitly
      RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_PROJECT_ID }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - language: English
            code: en
            model: facebook/wav2vec2-large-xlsr-53-english
          - language: Spanish
            code: es
            model: facebook/wav2vec2-large-xlsr-53-spanish
          - language: French
            code: fr
            model: facebook/wav2vec2-large-xlsr-53-french
          - language: German
            code: de
            model: facebook/wav2vec2-large-xlsr-53-german
          - language: Italian
            code: it
            model: facebook/wav2vec2-large-xlsr-53-italian
          - language: Portuguese
            code: pt
            model: facebook/wav2vec2-large-xlsr-53-portuguese
          - language: Japanese
            code: ja
            model: jonatasgrosman/wav2vec2-large-xlsr-53-japanese
          - language: Chinese
            code: zh
            model: jonatasgrosman/wav2vec2-large-xlsr-53-chinese-zh-cn
          - language: Hindi
            code: hi
            model: jonatasgrosman/wav2vec2-large-xlsr-53-hindi
          - language: Arabic
            code: ar
            model: jonatasgrosman/wav2vec2-large-xlsr-53-arabic

    steps:
      - uses: actions/checkout@v3

      - name: Install Railway CLI
        run: npm install -g @railway/cli

      - name: Deploy ${{ matrix.language }}
        run: |
          # If you prefer to pass a project id, set RAILWAY_PROJECT_ID secret.
          if [ -n "$RAILWAY_PROJECT_ID" ]; then
            railway up --service "soundmirror-${{ matrix.code }}" --detach --project-id "$RAILWAY_PROJECT_ID"
            railway variables set MODEL_ID="${{ matrix.model }}" LANGUAGE="${{ matrix.code }}" --service "soundmirror-${{ matrix.code }}" --project-id "$RAILWAY_PROJECT_ID"
          else
            railway up --service "soundmirror-${{ matrix.code }}" --detach || railway up --detach
            railway variables set MODEL_ID="${{ matrix.model }}" LANGUAGE="${{ matrix.code }}" --service "soundmirror-${{ matrix.code }}"
          fi
